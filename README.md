# kubernetes-podcertificate-signer

kubernetes-podcertificate-signerCustom is a custom controller for generating certificates based on the requests generated by pods. It is an early stage development and due to the feature being in alpha does required to enable feature flags and customisation of the runtime. 


# Setup kind for testing
The easiest way to run the contoller is to use `kind` and create a small cluster that would be used to simulation of the setup.

## Sample kind configuration 
For simple testing the following configuration can be used to spin up a test cluster.
```
---
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
featureGates:
  "PodCertificateRequest": true # For Pod generated certificates
  "ImageVolume": true # For mounting OCI volumes
  "StructuredAuthenticationConfiguration": true
  "MutatingAdmissionPolicy": true # https://kubernetes.io/docs/reference/access-authn-authz/mutating-admission-policy/
runtimeConfig:
  "certificates.k8s.io/v1alpha1/podcertificaterequests": "true" # For Pod generated certificates
  "admissionregistration.k8s.io/v1beta1": "true" # For MutatingAdmissionPolicy
containerdConfigPatches:
- |-
  [plugins."io.containerd.grpc.v1.cri".registry.mirrors."gitea.raftech.localtest.me:8443"]
    endpoint = ["https://gitea.raftech.localtest.me"]
  [plugins."io.containerd.grpc.v1.cri".registry.configs."gitea.cnoe.localtest.me".tls]
    insecure_skip_verify = true
nodes:
- role: control-plane
  image: "kindest/node:v1.34.0"
  labels:
    ingress-ready: "true"
  extraPortMappings:
  - containerPort: 443
    hostPort: 8443
    protocol: TCP
  - containerPort: 32222
    hostPort: 32222
    protocol: TCP  
```

## Controller and its configuration
The controller is currently

## Sample deployment
The following can be used to create a deployment which will trigger new PodCertificateRequests to be issued by the kube-api
```yaml
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: podcertificate-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: podcertificate-app
  template:
    metadata:
      labels:
        app: podcertificate-app
      annotations:
        coolcert.example.com/foo-cn: "some-epic-name.com"
        coolcert.example.com/foo-san: "example.com, www.example.com, anotherexample.com.cy"
        coolcert.example.com/foo-duration: "2h"
    spec:
      serviceAccountName: default
      containers:
      - image: debian
        name: main
        command: ["sleep", "infinity"]
        volumeMounts:
        - name: my-x509-credentials
          mountPath: /var/run/my-x509-credentials
      volumes:
      - name: my-x509-credentials
        projected:
          defaultMode: 420
          sources:
          - podCertificate:
              keyType: ED25519
              signerName: coolcert.example.com/foo
              credentialBundlePath: credentialbundle.pem
```


## Development in progress 

```sh
kubebuilder init --domain=operators.raftech.io --repo=github.com/rafpe/kubernetes-podcertificate-signer --project-name podcert
kubebuilder create api --group certificates --version v1alpha1 --kind PodCertificateRequest --controller --resource=false
```